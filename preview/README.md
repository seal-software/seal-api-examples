# Seal API (v5) Example - Document Preview

The purpose of this example implementation is to demonstrate how the Seal API
can be used to render a preview of a document and visualising it's metadata in
different ways.

In this particular example a contract's preview will be rendered with all
annotated text ranges shown with dotted over and underlines, standard clauses
shown in light blue and non-standard shown in light red. Hovering over any of
the annotations will instead of showing dotted lines show a solid black line and
annotations without a default background color will be shown in light yellow.


## Overview

[index.html](#html "save:") is the main document for this example, open it in
a web browser to try it out.

> *Note:* index.html is generated by running `npm install`. All the source is
> located in [README.md](README.md) (this file).

`settings.js` should contain the settings for this demo (e.g. credentials
and API location.)

[src/lib.js](src/lib.js) contains the more low-level functionality interacting
directly with the API. Have a look inside this file for a more detailed
description of the API interactions.

The API endpoints that are used are `/v5/auths`, `/v5/security/nonce`
`/v5/contracts/{id}/preview`, `/v5/contracts/{id}/metadata`.

## Getting Started

Start by copying the file [copy-to-settings.js](copy-to-settings.js) to
`settings.js`. Then edit `settings.js` and set the values to match your
environment and Seal instance.

To view the demo run `npm start` then open a browser and go to the URL displayed
in the terminal. It is required to run the [index.html](index.html) file from a
web server otherwise the browser will not allow the demo to make requests to the
API because of CORS. You don't need to use `npm` if you are running another web
server locally, just drop these files into your web server instead.


## HTML

The main file which will bootstrap the rest.

```html
<!DOCTYPE html>
<html>
  <head>
```

Style block that contains all the styles (see [Style](#style)).

```html
    <style>
      _"Style"
    </style>
  </head>
  <body>
```

Element that will contain the preview HTML.

```html
    <preview id="preview"></preview>
```

Include example client library for interacting with the Seal API.

```html
    <script src="./src/lib.js"></script>
```

Include parameters such as API host and user credentials.

```html
    <script src="./settings.js"></script>
```

Script block that contains the main logic (see [Code](#code)).

```html
    <script>
      _"Code"
    </script>
```

```html
  </body>
</html>
```


## Style

Stylesheet that contains all the style definitions.

All annotations.

```css
annotation {
  border-top: 1px dotted;
  border-bottom: 1px dotted;
  box-sizing: border-box;
}
```

When highlighted e.g. on mouse over.

```css
.highlight {
  background-color: lightyellow;
  border-top-style: solid;
  border-bottom-style: solid;
}
```

Standard clauses.

```css
.standard {
  background-color: lightblue;
}
```

Non-standard clauses.

```css
.non-standard {
  background-color: pink;
}
```


## Code

The main logic for how the preview is presented. A lot of the underlying
low-level code is located in [src/lib.js](src/lib.js).

General steps in the example code:

- Authenticate user and retrieve an API token: `/v5/security/nonce`, `/v5/auth`
- Fetch preview markup and contract metadata `/v5/contracts/{id}/preview`,
  `/v5/contracts/{id}/metadata`
- Render markup to DOM
- Register mouse events to create hover effects

```javascript
(function() {
  var apiUrl = demoSettings.host + "/seal-ws/v5",
      contractId = demoSettings.contractId;
```

Fetch a valid API session token.

```javascript
  demoLib.login({
    url: apiUrl,
```

User credentials declared in `settings.js`.


```javascript
    user: demoSettings.username,
    pass: demoSettings.password,
  }, function(err, token) {
```

Check if login was successful.

```javascript
    if (err != null) return console.error(err);
```

Create a demo lib instance with the retrieved API token and fetch both
contract preview markup as HTML and metadata.

```javascript
    demoLib(apiUrl, token).getAll(contractId, function(err, data) {
      if (err != null) return console.error(err);
```

Call our initialization function with the data retrieved through the API.

```javascript
      init(data.html, data.metadata);
    });
  });
```


This function takes the preview markdown and metadata, renders them to
the DOM and sets up all mouse events.

```javascript
  function init(html, metadata) {
```

Function for mapping a `scaType` metadata value to a CSS class name.
The corresponding values should also be added as CSS class name selectors
to the `preview.html` stylesheet.

```javascript
    function type(x) {
      return ({
        'standard': 'standard',
        'non-standard': 'non-standard',
      })[x.toLowerCase()];
    }
```

Event handler for mouse over events.

```javascript
    function mouseOver(e) {
```

Stop the event from propagating beyond the target element so that only
then inner most elements are highlighted.

```javascript
      e.stopPropagation();
```

Find all elements matching the target elements id and add the `highlight` class
name to each of them.

```javascript
      [].forEach.call(document.querySelectorAll('#'+e.target.id), function(el) {
        el.classList.add('highlight');
      });
    }
```

Event handler for mouse out events.

```javascript
    function mouseOut(e) {
```

Find all elements matching the target elements id and remove the `highlight`
class name from each of them.

```javascript
      [].forEach.call(document.querySelectorAll('#'+e.target.id), function(el) {
        el.classList.remove('highlight');
      });
    }
```

Register mouse over and mouse out event handlers on the given element.

```javascript
    function registerHover(el) {
      el.onmouseover = mouseOver;
      el.onmouseout = mouseOut;
    }
```

Find an element and render the preview HTML into it.

```javascript
    var previewEl = document.getElementById("preview");
    previewEl.innerHTML = html;
```

Style all annotations that have a metadata value for `scaType` with
it's corresponding CSS class name.

```javascript
    demoLib.toList(metadata)
```

Don't style elements which do not have an `scaType` metadata value set.

```javascript
    .filter(function(x) {
      return x.attributes.scaType != null;
    })
```

Get each annotation element which has the metadata item's id and add a class
name.

```javascript
    .forEach(function(x) {
      [].forEach.call(document.querySelectorAll('#'+x.id), function(el) {
        el.classList.add(type(x.attributes.scaType));
      });
    });
```

Add a mouse hover effect on each annotation.

```javascript
    Object.keys(metadata).forEach(function(id) {
```

Register mouse events to each annotation element that matches the metadata
item's id.

```javascript
      [].forEach.call(document.querySelectorAll('#'+id), registerHover);
    });
  }
})();
```
